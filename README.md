### RDP Broker

Цель проекта - объединить отдельные XRDP серверы в единый кластер.
*RDP Broker* работает параллельно с XRDP. Это сделано для того, чтобы:
1. Не вносить изменения в проект с XRDP, и в случае чего иметь возможность не отдавать исходники проекта *RDP Broker* сообществу.
2. Проверка *proof-of-concept*

Проект *RDP Broker* построен на базе библиотек проекта *FreeRDP* и *NNG*.

На каждом хосте, на котором запущен демон **xrdp** необходимо запустиь **rdp-agent** с конфигурационным файлом вида:
```
[server]
; examples: tcp://*:5555, tcp://127.0.0.01:5555 
interface=tcp://192.168.1.121:5555

[logs]
; LOG_NONE, LOG_ERR, LOG_WARN, LOG_NOTICE, LOG_INFO, LOG_DEBUG
level=LOG_NOTICE

[bash_script]
file=/opt/rdp-agent/agent.sh
```

Из интересного здесь только *bash* скрипт "/opt/rdp-agent/agent.sh", который на вход получает имя пользователя,
и возращает информацию о том, есть ли такой пользователь на сервере. 
И если есть, то как давно была запущена сессия пользователя. Также скрипт возвращает значение *"RDP LA"*, 
т.е. загрузка сервера в зависимости от количества **xrdp** сессий. Эта информация нужна для принятия решения о 
том, где начать новую сессию, если пользователь не представлен ни на одном из серверов.

На выделенном хосте запускается демон **rdp-broker** с конфигурационным файлом
```
[server]
; examples: 127.0.0.1, 192.168.1.99. Возможно, стоит поменять "*" на ALL
interface=*
port=3389

[logs]
; LOG_NONE, LOG_ERR, LOG_WARN, LOG_NOTICE, LOG_INFO, LOG_DEBUG
level=LOG_NOTICE

[tls]
cert=/opt/freerdp3/etc/proxy.crt
key=/opt/freerdp3/etc/proxy.key

[agents]
url-1=tcp://192.168.1.121:5555
url-2=tcp://192.168.1.122:5555
```

Сертификат и ключ лучше взять из инсталляции **xrdp**, но можно сгенерировать и свой. От этого зависит, сколько раз 
rdp-client будет спрашивать подтверждение валидности сертификата, один или два раза.

Работы по дальнейшуму улучшению проекта *RDP Broker* (тезисно):

1. ~~Сделать так, чтобы broker/agent запускались как демоны~~
2. Доработать систему логирования Брокера и Агента при запуске в качестве демона
3. ~~Сделать более строгую проверку того, что задается в конфигурационных файлах~~ 
4. TLS соединение между брокером и агентами
5. ~~Сделать обращение брокера к агентам параллельным, а не последовательным, как сейчас.~~
Частично сделано. Стоит ли продолжать упорствовать дальше покажет время.
6. Может быть включить логику работы bash-скрипта в состав агента. Но это только после того, как все утрясется.
7. Придумать, как запускать демоны **rdp-broker** и **xrdp** на одном хосте, и нужно ли это вообще.